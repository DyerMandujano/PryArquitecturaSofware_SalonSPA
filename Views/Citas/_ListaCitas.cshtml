@model IEnumerable<Pry_Solu_SalonSPA.Models.Cita>

<link href="~/css/VCitas/_ListaCitas.css" rel="stylesheet" />

<div class="contenedor-citas">

    <div class="fila-cita encabezado" role="row">
        <div>Cliente</div>
        <div>Empleado</div>
        <div>Servicio</div>
        <div>Fecha</div>
        <div>Hora</div>
        <div>Precio</div>
        <div>Estado</div>
        <div>Fase</div>
        <div>Acciones</div>
    </div>

    @if (Model != null && Model.Any())
    {
        foreach (var cita in Model)
        {
            var cliente = cita.IdClienteNavigation?.IdPersonaNavigation;
            var empleadoPersona = cita.IdEmpleadoHorarioNavigation?.IdEmpleadoNavigation?.IdPersonaNavigation;

            if (cita.CitaServicios != null && cita.CitaServicios.Any())
            {
                foreach (var cs in cita.CitaServicios)
                {
                    <div class="fila-cita" role="row">
                        <div class="celda" data-label="Cliente">
                            @(cliente != null ? $"{cliente.Nombres} {cliente.Apellidos}" : "")
                        </div>

                        <div class="celda" data-label="Empleado">
                            @(empleadoPersona != null ? $"{empleadoPersona.Nombres} {empleadoPersona.Apellidos}" : "")
                        </div>

                        <div class="celda" data-label="Servicio">@cs.IdServicioNavigation?.Nombre</div>
                        <div class="celda" data-label="Fecha">@cita.FechaCita.ToString("dd/MM/yyyy")</div>
                        <div class="celda" data-label="Hora">@cita.FechaCita.ToString("HH:mm")</div>
                        <div class="celda" data-label="Precio">@cs.IdServicioNavigation?.Precio.ToString("C")</div>

                        <div class="celda" data-label="Estado Cita">
                            <div class="div-estados">
                                @{
                                    string estadoCitaTexto = cita.Estado switch
                                    {
                                        1 => "Pendiente",
                                        2 => "Completado",
                                        3 => "Reprogramado",
                                        4 => "Cancelado",
                                        _ => "Desconocido"
                                    };

                                    string badgeCita = cita.Estado switch
                                    {
                                        1 => "badge-pendiente",
                                        2 => "badge-completado",
                                        3 => "badge-reprogramado",
                                        4 => "badge-cancelado",
                                        _ => "badge-secondary"
                                    };
                                }
                                <span class="badge @badgeCita">@estadoCitaTexto</span>
                            </div>
                        </div>

                        <div class="celda" data-label="Estado Servicio">
                            <div class="div-estados">
                                @{
                                    string estadoServicioTexto = cs.Estado switch
                                    {
                                        1 => "Activo",
                                        2 => "Inactivo",
                                        _ => "Desconocido"
                                    };
                                    string badgeServicio = cs.Estado switch
                                    {
                                        1 => "badge-completado",
                                        2 => "badge-cancelado",
                                        _ => "badge-secondary"
                                    };
                                }
                                <span class="badge @badgeServicio">@estadoServicioTexto</span>
                            </div>
                        </div>

                        <div class="celda acciones" data-label="Acciones">
                            <a href="javascript:void(0);"
                               onclick="document.getElementById('detalle-@cita.IdCita').classList.toggle('mostrar');"
                               class="btn-accion detalles" title="Ver observaciones">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a asp-action="Editar"
                               asp-route-id="@cita.IdCita"
                               asp-route-dni="@ViewBag.DniActual"
                               asp-route-fechaInicio="@ViewBag.FechaInicio"
                               asp-route-fechaFin="@ViewBag.FechaFin"
                               asp-route-estadoCita="@ViewBag.EstadoCitaSeleccionado"
                               asp-route-estadoServicio="@ViewBag.EstadoServicioSeleccionado"
                               asp-route-pageNumber="@ViewBag.PageNumber"
                               asp-route-pageSize="@ViewBag.PageSize"
                               class="btn-accion editar"
                               title="Editar cita">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form asp-action="CambiarEstado"
                                  method="post"
                                  style="display:inline"
                                  onsubmit="return confirm('¿Está seguro de cambiar el estado de esta cita?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@cita.IdCita" />
                                <input type="hidden" name="dni" value="@ViewBag.DniActual" />
                                <input type="hidden" name="fechaInicio" value="@ViewBag.FechaInicio" />
                                <input type="hidden" name="fechaFin" value="@ViewBag.FechaFin" />
                                <input type="hidden" name="estadoCita" value="@ViewBag.EstadoCitaSeleccionado" />
                                <input type="hidden" name="estadoServicio" value="@ViewBag.EstadoServicioSeleccionado" />
                                <input type="hidden" name="pageNumber" value="@ViewBag.PageNumber" />
                                <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                                <button type="submit"
                                        class="btn-accion @(cita.Estado == 4 ? "activar" : "eliminar")"
                                        title="@(cita.Estado == 4 ? "Activar cita" : "Desactivar cita")">
                                    <i class="bi @(cita.Estado == 4 ? "bi-check-circle" : "bi-x-circle")"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="fila-cita" role="row">
                    <div class="celda" data-label="Cliente">@(cliente != null ? $"{cliente.Nombres} {cliente.Apellidos}" : "")</div>
                    <div class="celda" data-label="Empleado">@(empleadoPersona != null ? $"{empleadoPersona.Nombres} {empleadoPersona.Apellidos}" : "")</div>
                    <div class="celda" data-label="Servicio"></div>
                    <div class="celda" data-label="Fecha">@cita.FechaCita.ToString("dd/MM/yyyy")</div>
                    <div class="celda" data-label="Hora">@cita.FechaCita.ToString("HH:mm")</div>
                    <div class="celda" data-label="Precio"></div>
                    <div class="celda" data-label="Estado Cita">
                        <div class="div-estados">
                            @{
                                string estadoCitaTexto = cita.Estado switch
                                {
                                    1 => "Pendiente",
                                    2 => "Completado",
                                    3 => "Reprogramado",
                                    4 => "Cancelado",
                                    _ => "Desconocido"
                                };
                                string badgeCita = cita.Estado switch
                                {
                                    1 => "badge-pendiente",
                                    2 => "badge-completado",
                                    3 => "badge-reprogramado",
                                    4 => "badge-cancelado",
                                    _ => "badge-secondary"
                                };
                            }
                            <span class="badge @badgeCita">@estadoCitaTexto</span>
                        </div>
                    </div>
                    <div class="celda" data-label="Estado Servicio">
                        <div class="div-estados">
                            <span class="badge badge-secondary">Sin servicios</span>
                        </div>
                    </div>
                    <div class="celda acciones" data-label="Acciones">
                        <a asp-action="Editar"
                           asp-route-id="@cita.IdCita"
                           asp-route-dni="@ViewBag.DniActual"
                           asp-route-fechaInicio="@ViewBag.FechaInicio"
                           asp-route-fechaFin="@ViewBag.FechaFin"
                           asp-route-estadoCita="@ViewBag.EstadoCitaSeleccionado"
                           asp-route-estadoServicio="@ViewBag.EstadoServicioSeleccionado"
                           asp-route-pageNumber="@ViewBag.PageNumber"
                           asp-route-pageSize="@ViewBag.PageSize"
                           class="btn-accion editar"
                           title="Editar cita">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form asp-action="CambiarEstado"
                              method="post"
                              style="display:inline"
                              onsubmit="return confirm('¿Está seguro de cambiar el estado de esta cita?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@cita.IdCita" />
                            <input type="hidden" name="dni" value="@ViewBag.DniActual" />

                            <input type="date" name="fechaInicio" value="@ViewBag.FechaInicio" />
                            <input type="date" name="fechaFin" value="@ViewBag.FechaFin" />


                            <input type="hidden" name="estadoCita" value="@ViewBag.EstadoCitaSeleccionado" />
                            <input type="hidden" name="estadoServicio" value="@ViewBag.EstadoServicioSeleccionado" />
                            <input type="hidden" name="pageNumber" value="@ViewBag.PageNumber" />
                            <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                            <button type="submit"
                                    class="btn-accion @(cita.Estado == 4 ? "activar" : "eliminar")"
                                    title="@(cita.Estado == 4 ? "Activar cita" : "Desactivar cita")">
                                <i class="bi @(cita.Estado == 4 ? "bi-check-circle" : "bi-x-circle")"></i>
                            </button>
                        </form>
                    </div>
                </div>
            }

            <div id="detalle-@cita.IdCita" class="detalle-observacion" aria-hidden="true">
                <button type="button" class="btn-cerrar-detalle"
                        onclick="document.getElementById('detalle-@cita.IdCita').classList.remove('mostrar');">
                    &times;
                </button>
                <strong>Observaciones del servicio:</strong>
                <ul>
                    <li>@(string.IsNullOrWhiteSpace(cita.Descripcion) ? "Sin observaciones" : cita.Descripcion)</li>
                </ul>
            </div>
        }
    }
    else
    {
        <div class="fila-cita vacio">
            <div class="celda" data-label="Sin registros">No se encontraron citas registradas.</div>
        </div>
    }
</div>
