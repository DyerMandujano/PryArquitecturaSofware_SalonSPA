@model Pry_Solu_SalonSPA.ViewModels.CompraRegistrarVM

@{
    Layout = "~/Views/Main.cshtml";
    ViewData["Title"] = "Registrar Compra";
}

<link href="~/css/VCompras/_RegistrarCompras.css" rel="stylesheet" />

<div class="registrar-compra-wrapper">
    <div class="registrar-compra-box">
        <div class="container mt-4">

            <a asp-action="Index" class="btn btn-secondary mb-3">← Volver</a>

            <h2 class="mb-3">Registrar Compra</h2>

            <form asp-action="Registrar" method="post">
                <div class="row mb-3">

                    <!-- Fecha -->
                    <div class="col-md-4">
                        <label class="form-label">Fecha de Compra</label>
                        <input type="date" asp-for="FechaCompra" class="form-control" />
                    </div>

                    <!-- Proveedor -->
                    <div class="col-md-4">
                        <label class="form-label">Proveedor</label>
                        <select asp-for="IdProveedor" class="form-control">
                            <option value="">--Seleccione--</option>
                            @foreach (var p in Model.Proveedor)
                            {
                                <option value="@p.IdProveedor">@p.NomProve</option>
                            }
                        </select>
                    </div>

                    <!-- Tipo Documento -->
                    <div class="col-md-4">
                        <label class="form-label">Tipo de Documento</label>
                        <select asp-for="TipoDoc" class="form-control">
                            <option value="">--Seleccione--</option>
                            <option value="FACTURA">FACTURA</option>
                            <option value="BOLETA">BOLETA</option>
                        </select>
                    </div>
                </div>

                <hr />

                <!-- TABLA DETALLES -->
                <h4>Detalles de Compra</h4>

                <table class="table table-bordered mt-3" id="tablaDetalles">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 35%">Producto</th>
                            <th style="width: 10%">Cant</th>
                            <th style="width: 15%">Precio</th>
                            <th style="width: 15%">Subtotal</th>
                            <th style="width: 10%">#</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Al inicio tabla vacía, se agrega con JS -->
                    </tbody>
                </table>

                <button type="button" class="btn btn-primary" id="btnAgregarFila">+ Agregar fila</button>

                <hr />

                <!-- MONTO TOTAL -->
                <div class="row mt-3">
                    <div class="col-md-3 ms-auto">
                        <label class="form-label">Monto Total</label>
                        <input type="text" asp-for="MontoTotal" class="form-control" readonly id="MontoTotal" />
                    </div>
                </div>

                <button type="submit" class="btn btn-success mt-4">Registrar Compra</button>
            </form>
        </div>
    </div>
</div>

<!-- ============================= -->
<!--          JAVASCRIPT           -->
<!-- ============================= -->
<script>
    let filaIndex = 0; // índice dinámico para Detalles[x]

    document.getElementById("btnAgregarFila").addEventListener("click", function () {
        agregarFila();
    });

    function agregarFila() {

        let tbody = document.querySelector("#tablaDetalles tbody");

        let fila = document.createElement("tr");
        fila.setAttribute("data-index", filaIndex);

        fila.innerHTML = `
            <td>
                <select name="Detalles[${filaIndex}].IdProducto" class="form-control productoSelect">
                    <option value="">--Seleccione--</option>
                    @foreach (var prod in Model.Productos)
                    {
                                <option value="@prod.IdProducto" data-precio="@prod.Precio">@prod.NomProd</option>
                    }
                </select>
            </td>

            <td>
                <input type="number" name="Detalles[${filaIndex}].Cantidad" class="form-control cantidad" min="1" value="1" />
            </td>

            <td>
                <input type="number" step="0.01" name="Detalles[${filaIndex}].PrecioCompra" class="form-control precio" />
            </td>

            <td>
                <input type="text" class="form-control subtotal" readonly />
            </td>

            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button>
            </td>
        `;

        tbody.appendChild(fila);

        configurarEventosFila(fila);

        filaIndex++;
    }

    function configurarEventosFila(fila) {
        let selectProducto = fila.querySelector(".productoSelect");
        let cantidad = fila.querySelector(".cantidad");
        let precio = fila.querySelector(".precio");

        selectProducto.addEventListener("change", function () {
            let option = selectProducto.options[selectProducto.selectedIndex];
            let precioProducto = option.getAttribute("data-precio");
            if (precioProducto) precio.value = precioProducto;
            calcularSubtotal(fila);
        });

        cantidad.addEventListener("input", function () {
            calcularSubtotal(fila);
        });

        precio.addEventListener("input", function () {
            calcularSubtotal(fila);
        });
    }

    function calcularSubtotal(fila) {
        let cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
        let precio = parseFloat(fila.querySelector(".precio").value) || 0;
        let subtotal = cantidad * precio;

        fila.querySelector(".subtotal").value = subtotal.toFixed(2);

        calcularTotal();
    }

    function calcularTotal() {
        let subtotales = document.querySelectorAll(".subtotal");
        let total = 0;

        subtotales.forEach(s => {
            total += parseFloat(s.value) || 0;
        });

        document.getElementById("MontoTotal").value = total.toFixed(2);
    }

    function eliminarFila(btn) {
        btn.closest("tr").remove();
        calcularTotal();
    }
</script>